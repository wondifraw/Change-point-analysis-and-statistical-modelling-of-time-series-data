<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brent Oil Price Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .card { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 5px; transition: background 0.3s; }
        .stat-item:hover { background: #e9ecef; }
        .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .chart-container { height: 400px; margin: 20px 0; position: relative; }
        .events-list { max-height: 300px; overflow-y: auto; }
        .event-item { padding: 10px; border-left: 4px solid #007bff; margin: 5px 0; background: #f8f9fa; cursor: pointer; transition: background 0.2s; }
        .event-item:hover { background: #e9ecef; }
        .loading { text-align: center; color: #666; }
        .controls { margin: 20px 0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        .control-group label { font-weight: bold; color: #495057; }
        .control-group select, .control-group input { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .upload-area { border: 2px dashed #ced4da; padding: 40px; text-align: center; border-radius: 8px; margin: 20px 0; transition: border-color 0.3s; }
        .upload-area:hover { border-color: #007bff; }
        .upload-area.dragover { border-color: #007bff; background: #f8f9fa; }
        .method-comparison { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .method-card { padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ¢Ô∏è Brent Oil Price Analysis Dashboard</h1>
            <p>Advanced Change Point Detection & Geopolitical Events Analysis</p>
            <p><small>üí° Tip: Use Ctrl+D for quick detection, Ctrl+C for method comparison</small></p>
        </div>

        <div class="card">
            <h2>üìä Summary Statistics</h2>
            <div id="summary-stats" class="stats">
                <div class="loading">Loading statistics...</div>
            </div>
        </div>

        <div class="card">
            <h2>üìà Oil Price Timeline</h2>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>üéØ Change Points Detected</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="method-select">Detection Method:</label>
                    <select id="method-select">
                        <option value="pelt">PELT</option>
                        <option value="binseg">Binary Segmentation</option>
                        <option value="window">Sliding Window</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="penalty-input">Penalty Parameter:</label>
                    <input type="number" id="penalty-input" value="10" min="1" max="100" step="1">
                </div>
                <button class="btn" onclick="runCustomDetection()">üîç Detect Change Points</button>
                <button class="btn btn-secondary" onclick="compareAllMethods()">üìä Compare Methods</button>
            </div>
            <div id="change-points">
                <div class="loading">Loading change points...</div>
            </div>
        </div>

        <div class="card">
            <h2>üì§ Upload Custom Data</h2>
            <div class="upload-area" id="upload-area">
                <p>üìÅ Drag and drop your CSV file here, or <button class="btn" onclick="document.getElementById('file-input').click()">Browse Files</button></p>
                <input type="file" id="file-input" accept=".csv" style="display: none;" onchange="handleFileUpload(event)">
                <small>CSV should contain 'Date' and 'Price' columns</small>
            </div>
            <div id="upload-status"></div>
        </div>

        <div class="card" id="method-comparison-card" style="display: none;">
            <h2>üî¨ Method Comparison Results</h2>
            <div id="method-comparison-results" class="method-comparison">
                <div class="loading">Running comparison...</div>
            </div>
        </div>

        <div class="card">
            <h2>üåç Major Geopolitical Events</h2>
            <div id="events-list" class="events-list">
                <div class="loading">Loading events...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000/api';

        // Load summary statistics
        async function loadSummary() {
            try {
                const response = await fetch(`${API_BASE}/analysis-summary`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('summary-stats').innerHTML = `
                        <div class="stat-item">
                            <div class="stat-value">${stats.data_overview.total_observations.toLocaleString()}</div>
                            <div>Total Observations</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">$${stats.price_statistics.mean.toFixed(2)}</div>
                            <div>Average Price</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.analysis_results.change_points_detected}</div>
                            <div>Change Points</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.analysis_results.events_analyzed}</div>
                            <div>Events Analyzed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.data_overview.years_covered}</div>
                            <div>Years Covered</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${(stats.price_statistics.volatility * 100).toFixed(2)}%</div>
                            <div>Daily Volatility</div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('summary-stats').innerHTML = '<div style="color: red;">Error loading statistics</div>';
            }
        }

        // Load and display price chart
        async function loadPriceChart() {
            try {
                const response = await fetch(`${API_BASE}/oil-prices?start_date=2020-01-01`);
                const data = await response.json();
                
                if (data.success) {
                    const ctx = document.getElementById('priceChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.data.map(d => d.date),
                            datasets: [{
                                label: 'Brent Oil Price (USD)',
                                data: data.data.map(d => d.price),
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: { display: true, text: 'Price (USD)' }
                                },
                                x: {
                                    title: { display: true, text: 'Date' }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading price chart:', error);
            }
        }

        // Load change points
        async function loadChangePoints() {
            try {
                const response = await fetch(`${API_BASE}/change-points`);
                const data = await response.json();
                
                if (data.success) {
                    displayChangePoints(data.data);
                }
            } catch (error) {
                document.getElementById('change-points').innerHTML = '<div style="color: red;">Error loading change points</div>';
            }
        }

        function displayChangePoints(changePoints) {
            const html = changePoints.map(cp => `
                <div class="event-item" onclick="highlightChangePoint('${cp.date}')">
                    <strong>üìç ${cp.date}</strong><br>
                    Method: ${cp.method}<br>
                    Price Change: ${cp.change_percent.toFixed(1)}% 
                    ($${cp.before_mean.toFixed(2)} ‚Üí $${cp.after_mean.toFixed(2)})<br>
                    <small>Confidence: ${(cp.confidence * 100).toFixed(1)}%</small>
                </div>
            `).join('');
            document.getElementById('change-points').innerHTML = html || '<div>No change points detected</div>';
        }

        // Custom change point detection
        async function runCustomDetection() {
            const method = document.getElementById('method-select').value;
            const penalty = parseFloat(document.getElementById('penalty-input').value);
            
            document.getElementById('change-points').innerHTML = '<div class="loading">üîç Detecting change points...</div>';
            
            try {
                // Get current oil data
                const oilResponse = await fetch(`${API_BASE}/oil-prices`);
                const oilData = await oilResponse.json();
                
                if (!oilData.success) {
                    throw new Error('Failed to load oil data');
                }
                
                // Run custom detection
                const response = await fetch(`${API_BASE}/detect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        time_series: oilData.data.map(d => ({date: d.date, price: d.price})),
                        method: method,
                        penalty: penalty
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const changePoints = result.data.change_points.map((cp, i) => ({
                        date: result.data.change_dates[i] || 'Unknown',
                        method: result.data.method,
                        change_percent: Math.random() * 50 - 25, // Placeholder
                        before_mean: Math.random() * 100,
                        after_mean: Math.random() * 100,
                        confidence: 0.8 + Math.random() * 0.2
                    }));
                    
                    displayChangePoints(changePoints);
                    
                    // Show statistics
                    const stats = result.data.statistics;
                    document.getElementById('change-points').innerHTML += `
                        <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px;">
                            <strong>üìä Detection Statistics:</strong><br>
                            Method: ${result.data.method.toUpperCase()}<br>
                            Total Points: ${stats.total_points}<br>
                            Change Points: ${stats.change_points_detected}<br>
                            Detection Rate: ${stats.detection_rate.toFixed(2)}%
                        </div>
                    `;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('change-points').innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        // Compare all methods
        async function compareAllMethods() {
            document.getElementById('method-comparison-card').style.display = 'block';
            document.getElementById('method-comparison-results').innerHTML = '<div class="loading">üî¨ Comparing methods...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/methods-comparison`);
                const data = await response.json();
                
                if (data.success) {
                    const results = data.data.method_results;
                    const html = Object.entries(results).map(([method, result]) => {
                        if (result.error) {
                            return `
                                <div class="method-card">
                                    <h3>${method.toUpperCase()}</h3>
                                    <p style="color: red;">Error: ${result.error}</p>
                                </div>
                            `;
                        }
                        
                        const detectionRate = (result.change_points_count / 1000) * 100; // Assuming 1000 data points
                        
                        return `
                            <div class="method-card">
                                <h3>${method.toUpperCase()}</h3>
                                <p><strong>Change Points:</strong> ${result.change_points_count}</p>
                                <p><strong>Detection Rate:</strong></p>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${Math.min(detectionRate * 10, 100)}%"></div>
                                </div>
                                <small>${detectionRate.toFixed(2)}% of data points</small>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('method-comparison-results').innerHTML = html;
                    
                    // Add consensus information
                    if (data.data.consensus_points.length > 0) {
                        document.getElementById('method-comparison-results').innerHTML += `
                            <div class="method-card" style="grid-column: 1 / -1; background: #d4edda; border-color: #c3e6cb;">
                                <h3>üéØ Consensus Points</h3>
                                <p>Points detected by multiple methods:</p>
                                ${data.data.consensus_points.map(cp => 
                                    `<span style="background: #007bff; color: white; padding: 5px 10px; border-radius: 15px; margin: 2px; display: inline-block;">
                                        Point ${cp.point} (${cp.agreement_count} methods)
                                    </span>`
                                ).join('')}
                            </div>
                        `;
                    }
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('method-comparison-results').innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        // File upload handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            document.getElementById('upload-status').innerHTML = '<div class="loading">üì§ Uploading and validating file...</div>';
            
            fetch(`${API_BASE}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('upload-status').innerHTML = `
                        <div style="color: green; padding: 15px; background: #d4edda; border-radius: 5px; margin-top: 10px;">
                            <strong>‚úÖ File uploaded successfully!</strong><br>
                            Records: ${data.statistics.total_records}<br>
                            Date Range: ${data.statistics.date_range.start} to ${data.statistics.date_range.end}<br>
                            Price Range: $${data.statistics.price_stats.min.toFixed(2)} - $${data.statistics.price_stats.max.toFixed(2)}
                        </div>
                    `;
                } else {
                    document.getElementById('upload-status').innerHTML = `
                        <div style="color: red; padding: 15px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">
                            <strong>‚ùå Upload failed:</strong> ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('upload-status').innerHTML = `
                    <div style="color: red; padding: 15px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            });
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById('upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('file-input').files = files;
                handleFileUpload({target: {files: files}});
            }
        });

        function highlightChangePoint(date) {
            // Placeholder for highlighting change point on chart
            console.log('Highlighting change point:', date);
        }

        // Load events
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE}/events`);
                const data = await response.json();
                
                if (data.success) {
                    const html = data.data.map(event => `
                        <div class="event-item">
                            <strong>${event.date}</strong> - ${event.event}<br>
                            <small>Category: ${event.category} | Impact: ${event.impact}</small>
                        </div>
                    `).join('');
                    document.getElementById('events-list').innerHTML = html;
                }
            } catch (error) {
                document.getElementById('events-list').innerHTML = '<div style="color: red;">Error loading events</div>';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadSummary();
            loadPriceChart();
            loadChangePoints();
            loadEvents();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    runCustomDetection();
                }
                if (e.ctrlKey && e.key === 'c') {
                    e.preventDefault();
                    compareAllMethods();
                }
            });
        });
    </script>
</body>
</html>